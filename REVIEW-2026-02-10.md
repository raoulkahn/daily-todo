# Code Review — 2026-02-10

Review of the Daily Todo codebase for bugs, edge cases, and quality issues (per `/review`).

---

## Critical (must fix before shipping)

### 1. Stale closure in overlap check — `src/context/TodoContext.jsx`
**Issue:** `addTask` and `updateTask` use `tasks` from the closure for `hasOverlap()`. React state updates are async, so rapid consecutive add/update calls can both see the same stale `tasks`. The second call can get `{ success: true }` even when the setState callback later rejects the add (overlap), or two overlapping tasks can both be accepted.
**Fix:** Keep the latest tasks in a ref, and read from that ref inside add/update for the overlap check so we always use current data.

### 2. localStorage write can throw — `src/utils/storage.js`
**Issue:** `saveTasks()` calls `localStorage.setItem()` with no try/catch. In private mode, quota exceeded, or when storage is disabled, this can throw and break the app (e.g. the sync effect in TodoContext).
**Fix:** Wrap the write in try/catch; optionally log and continue so the in-memory state stays correct.

---

## High (should fix)

### 3. UX state consistency — end time change — `src/components/TaskModal.jsx`
**Issue:** When the user changes **start** time to be after **end** time, we auto-adjust end (good). When they change **end** time to be before **start** time, we do not; we only validate on submit. Per project learnings, the UI should prevent invalid states, not only reject on submit.
**Fix:** When end time changes, if `end <= start`, set end to `addThirtyMinutes(start)`.

### 4. TimePicker partial selection lost — `src/components/TimePicker.jsx`
**Issue:** We only call `onChange` when hour, minute, and period are all set. If the user selects only the hour (or hour + period), we don’t emit, so the parent `value` stays `''`. The next render uses `parseTimeTo12h('')`, so the UI shows the placeholder again and the user’s selection appears to disappear.
**Fix:** Use local state in TimePicker to hold the current partial selection (hour, minute, period). Sync from `value` when it changes (e.g. when modal opens). Emit to parent only when all three are set; until then show the partial selection from local state.

### 5. Malformed time strings — `src/utils/dateHelpers.js`
**Issue:**  
- `formatTime(timeString)`: `"10"` or `"ab:cd"` yields NaN and e.g. `"12:NaN AM"`.  
- `parseTimeTo12h(timeString)`: `"10"` (no colon) gives `minute: "NaN"`.  
- `to24hTime(hour, minute, period)`: if `minute` is undefined, result is `"09:undefined"`.
**Fix:** In `formatTime` and `parseTimeTo12h`, validate format (two numeric parts); return a safe fallback or empty for invalid input. In `to24hTime`, treat missing/minute empty as invalid and return `''`.

### 6. TaskItem keyboard accessibility — `src/components/TaskItem.jsx`
**Issue:** The row has `role="button"` and `tabIndex={0}` but only Enter is handled. Buttons should also activate on Space (WCAG).
**Fix:** In `onKeyDown`, if `e.key === ' '`, call `e.preventDefault()` and trigger the same action as the click.

---

## Medium (nice to fix)

### 7. Data loss on load error — `src/utils/storage.js`
**Issue:** If `JSON.parse(raw)` throws or `parsed` is not an array, we return `[]` and the user loses existing data with no message.
**Fix:** Consider logging, or returning a minimal “recovery” structure and surfacing a one-time message (e.g. “Data couldn’t be loaded”) so the user knows something went wrong.

### 8. Comment vs implementation — `src/context/TodoContext.jsx`
**Issue:** Comment says “Uses a ref to read the latest tasks” but no ref is used.
**Fix:** Resolved when implementing the ref for the overlap check (Critical #1).

---

## Low (minor)

### 9. Root element existence — `src/main.jsx`
**Issue:** `document.getElementById('root')` is not checked; in environments where `#root` is missing, `createRoot(null)` would throw.
**Fix:** Optional guard or document the assumption in a comment; low impact for normal usage.

---

## What was checked and is OK

- **Start/end time UX:** Start-time change already auto-adjusts end when start ≥ end (TaskModal).
- **Overlap logic:** `timesOverlap` and `hasOverlap` (excludeId for edit) are correct; string comparison for `"HH:mm"` is consistent.
- **Rollover:** Only past dates, `task.date < today`; invalid/missing date handled safely.
- **Modal:** Escape and overlay click close; body scroll locked when open; delete confirmation flow is clear.
- **Date navigation:** Uses dateHelpers; today button only when not today.
- **Task list:** Past dates show only completed tasks; empty state messages are correct.

---

## Fixes applied this session

- [x] Critical #1: TodoContext ref for latest tasks
- [x] Critical #2: saveTasks try/catch
- [x] High #3: End-time auto-adjust in TaskModal
- [x] High #4: TimePicker partial selection state
- [x] High #5: dateHelpers validation/guards (+ addThirtyMinutes, to24hTime period check)
- [x] High #6: TaskItem Space key
